<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de H√°bitos - Marcos</title>
    
    <!-- Firebase SDK Modular -->
    <script type="module">
        // =============================================
        // CONFIGURACI√ìN FIREBASE - USA TUS DATOS AQU√ç
        // =============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkP2qgjn4MbeKkxMD1O_bMon6TLs2vcZg",
            authDomain: "planificador-marcos.firebaseapp.com",
            projectId: "planificador-marcos",
            storageBucket: "planificador-marcos.firebasestorage.app",
            messagingSenderId: "433123531099",
            appId: "1:433123531099:web:f16a1d1dcc6cd34715e27e"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Hacer variables globales
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseModules = {
            doc, getDoc, setDoc, collection, query, orderBy, limit, getDocs, serverTimestamp, signInAnonymously
        };
        
        console.log("‚úÖ Firebase inicializado correctamente");
        document.getElementById('firebaseStatus').textContent = "‚úÖ Firebase listo";
    </script>

    <style>
        :root {
            --oro: #d4af37;
            --oro-oscuro: #b8860b;
            --bronce: #cd7f32;
            --negro: #0a0a0a;
            --negro-claro: #1a1a1a;
            --gris: #2d2d2d;
            --texto: #e8e0c8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: 
                linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(42, 42, 42, 0.9) 100%),
                url('https://images.unsplash.com/photo-1550684376-efcbd6e3f031?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80');
            background-size: cover;
            background-attachment: fixed;
            color: var(--texto);
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: rgba(10, 10, 10, 0.95);
            padding: 40px 30px;
            border-radius: 15px;
            border: 2px solid var(--oro);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .panel-container {
            max-width: 1200px;
            margin: 0 auto;
            display: none;
        }
        
        h1 {
            color: var(--oro);
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .subtitle {
            text-align: center;
            color: var(--bronce);
            margin-bottom: 30px;
        }
        
        .container {
            background: rgba(26, 26, 26, 0.9);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--gris);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        h2 {
            color: var(--oro);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid var(--bronce);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .habitos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .habito-card {
            background: rgba(45, 45, 45, 0.6);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--oro);
            transition: all 0.3s ease;
        }
        
        .habito-card:hover {
            border-left-color: var(--bronce);
            transform: translateY(-2px);
        }
        
        .habito-card h3 {
            color: var(--oro);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .checklist {
            list-style: none;
        }
        
        .checklist li {
            margin: 12px 0;
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .checklist li:hover {
            background: rgba(212, 175, 55, 0.1);
        }
        
        .checklist input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.3);
            accent-color: var(--oro);
        }
        
        .btn-eliminar {
            background: transparent;
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8em;
            transition: all 0.3s;
        }
        
        .btn-eliminar:hover {
            background: #ef4444;
            color: white;
        }
        
        .semana-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .dia-card {
            background: rgba(45, 45, 45, 0.6);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--gris);
            transition: all 0.3s;
        }
        
        .dia-card.completado {
            background: linear-gradient(135deg, var(--bronce), var(--oro-oscuro));
            color: var(--negro);
            border-color: var(--oro);
            font-weight: bold;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--oro), var(--bronce));
            color: var(--negro);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--oro);
            color: var(--oro);
            padding: 8px 16px;
        }
        
        .btn-outline:hover {
            background: var(--oro);
            color: var(--negro);
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            background: rgba(45, 45, 45, 0.8);
            border: 2px solid var(--gris);
            border-radius: 8px;
            color: var(--texto);
            font-size: 16px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .password-input:focus {
            border-color: var(--oro);
            outline: none;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }
        
        .error {
            color: var(--oro);
            margin: 10px 0;
            display: none;
        }
        
        .resumen-mensual {
            background: rgba(45, 45, 45, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid var(--gris);
        }
        
        .meta-card {
            background: rgba(26, 26, 26, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid var(--oro);
        }
        
        .progreso {
            height: 10px;
            background: var(--gris);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progreso-barra {
            height: 100%;
            background: linear-gradient(90deg, var(--bronce), var(--oro));
            border-radius: 5px;
            transition: width 0.3s;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(45, 45, 45, 0.6);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--gris);
        }
        
        .stat-numero {
            font-size: 2em;
            font-weight: bold;
            color: var(--oro);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--negro-claro);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--oro);
            max-width: 500px;
            width: 90%;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(45, 45, 45, 0.8);
            border: 1px solid var(--gris);
            border-radius: 6px;
            color: var(--texto);
        }
        
        .categoria-select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(45, 45, 45, 0.8);
            border: 1px solid var(--gris);
            border-radius: 6px;
            color: var(--texto);
        }
        
        .loading {
            text-align: center;
            color: var(--oro);
            margin: 20px 0;
        }
        
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--negro);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--oro);
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus">üîÑ Sincronizando...</div>

    <!-- PANTALLA DE LOGIn -->
    <div class="login-container" id="loginContainer">
        <h1>Mi Planificador</h1>
        <p class="subtitle">Seguimiento de h√°bitos con Firebase</p>
        
        <input type="password" class="password-input" id="passwordInput" placeholder="Contrase√±a personal">
        <div class="error" id="errorMsg">Contrase√±a incorrecta</div>
        <button class="btn" onclick="verificarPassword()">ENTRAR</button>
        
        <div class="loading" id="firebaseStatus">Conectando con Firebase...</div>
    </div>

    <!-- PANEL PRINCIPAL -->
    <div class="panel-container" id="panelContainer">
        <h1>Planificador de H√°bitos - Marcos</h1>
        <p class="subtitle">Hoy es <span id="fechaHoy"></span> - ¬°Construye tu legado!</p>

        <div class="container">
            <h2>
                üìÖ H√°bitos Diarios - Hoy
                <button class="btn-outline" onclick="mostrarModalAgregar()">+ Agregar H√°bito</button>
            </h2>
            <div class="habitos-grid" id="habitosGrid">
                <div class="loading">Cargando h√°bitos...</div>
            </div>
            
            <button class="btn" onclick="guardarDia()">üíæ GUARDAR D√çA EN FIREBASE</button>
        </div>

        <div class="container">
            <h2>üìä Progreso Semanal</h2>
            <div class="semana-grid" id="semanaGrid">
                <div class="loading">Cargando progreso...</div>
            </div>
            
            <div class="resumen-mensual">
                <h3>Metas Mensuales</h3>
                <div class="meta-card">
                    <strong>D√≠as productivos este mes:</strong>
                    <div class="progreso">
                        <div class="progreso-barra" id="progresoDias" style="width: 0%"></div>
                    </div>
                    <span id="contadorDias">0/30 d√≠as</span>
                </div>
                
                <div class="meta-card">
                    <strong>H√°bitos completados:</strong>
                    <div class="progreso">
                        <div class="progreso-barra" id="progresoHabitos" style="width: 0%"></div>
                    </div>
                    <span id="contadorHabitos">0% completado</span>
                </div>
            </div>
        </div>

        <div class="container">
            <h2>üìà Estad√≠sticas</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-numero" id="statRacha">0</div>
                    <div>D√≠as consecutivos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero" id="statHabitos">0%</div>
                    <div>H√°bitos completados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero" id="statSemanas">0</div>
                    <div>Semanas activas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero" id="statMejora">0%</div>
                    <div>Mejora mensual</div>
                </div>
            </div>
        </div>

        <div class="container">
            <button class="btn" onclick="cerrarSesion()">CERRAR SESI√ìN</button>
            <button class="btn-outline" onclick="exportarDatos()">üì§ EXPORTAR DATOS</button>
        </div>
    </div>

    <!-- MODAL AGREGAR H√ÅBITO -->
    <div class="modal" id="modalAgregar">
        <div class="modal-content">
            <h2>Agregar Nuevo H√°bito</h2>
            <input type="text" class="modal-input" id="nuevoHabito" placeholder="Descripci√≥n del h√°bito">
            <select class="categoria-select" id="categoriaHabito">
                <option value="ma√±ana">üåÖ Ma√±ana</option>
                <option value="dia">‚ö° D√≠a</option>
                <option value="noche">üåô Noche</option>
            </select>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn" onclick="agregarHabito()">AGREGAR</button>
                <button class="btn-outline" onclick="cerrarModalAgregar()">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        // CONTRASE√ëA DE LA APLICACI√ìN
        const APP_PASSWORD = "marcos2024";

        // Elementos del DOM
        const loginContainer = document.getElementById('loginContainer');
        const panelContainer = document.getElementById('panelContainer');
        const firebaseStatus = document.getElementById('firebaseStatus');
        const syncStatus = document.getElementById('syncStatus');
        const fechaHoy = document.getElementById('fechaHoy');
        const semanaGrid = document.getElementById('semanaGrid');
        const habitosGrid = document.getElementById('habitosGrid');
        const modalAgregar = document.getElementById('modalAgregar');

        // Estado global
        let usuarioId = null;
        let habitos = {
            "ma√±ana": [],
            "dia": [],
            "noche": []
        };

        // =============================================
        // INICIALIZACI√ìN Y AUTENTICACI√ìN
        // =============================================
        async function inicializarFirebase() {
            try {
                // Esperar a que Firebase se inicialice
                while (!window.firebaseAuth) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                syncStatus.textContent = "üîÑ Autenticando...";
                
                // Autenticaci√≥n an√≥nima
                const userCredential = await window.firebaseModules.signInAnonymously(window.firebaseAuth);
                usuarioId = userCredential.user.uid;
                
                syncStatus.textContent = "‚úÖ Conectado";
                setTimeout(() => syncStatus.style.display = 'none', 2000);
                
                console.log("Usuario autenticado:", usuarioId);
                
            } catch (error) {
                console.error("Error Firebase:", error);
                syncStatus.textContent = "‚ùå Error de conexi√≥n";
                firebaseStatus.textContent = "‚ùå Error conectando a Firebase";
            }
        }

        // =============================================
        // FUNCIONES PRINCIPALES - H√ÅBITOS
        // =============================================
        async function cargarHabitos() {
            try {
                syncStatus.style.display = 'block';
                syncStatus.textContent = "üì• Cargando h√°bitos...";
                
                const { doc, getDoc, setDoc } = window.firebaseModules;
                const habitosRef = doc(window.firebaseDb, 'usuarios', usuarioId, 'habitos', 'lista');
                const docSnap = await getDoc(habitosRef);
                
                if (docSnap.exists()) {
                    habitos = docSnap.data();
                } else {
                    // Crear h√°bitos por defecto
                    habitos = {
                        "ma√±ana": [
                            "Levantarme sin revisar el tel√©fono",
                            "Lavar cara y cepillar dientes",
                            "10 minutos de ejercicio", 
                            "Desayunar conscientemente"
                        ],
                        "dia": [
                            "1 hora de aprendizaje",
                            "Ayudar en casa 30 min",
                            "Contactar un amigo/familiar",
                            "Salir a caminar 20 min"
                        ],
                        "noche": [
                            "Sin pantallas 1h antes de dormir", 
                            "Leer 15 minutos",
                            "Planificar el d√≠a siguiente",
                            "Dormir antes de las 12 AM"
                        ]
                    };
                    await setDoc(habitosRef, habitos);
                }
                
                generarHabitosUI();
                syncStatus.textContent = "‚úÖ H√°bitos cargados";
                setTimeout(() => syncStatus.style.display = 'none', 2000);
                
            } catch (error) {
                console.error("Error cargando h√°bitos:", error);
                syncStatus.textContent = "‚ùå Error cargando h√°bitos";
            }
        }

        async function guardarHabitos() {
            try {
                syncStatus.style.display = 'block';
                syncStatus.textContent = "üíæ Guardando h√°bitos...";
                
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(window.firebaseDb, 'usuarios', usuarioId, 'habitos', 'lista'), habitos);
                
                syncStatus.textContent = "‚úÖ H√°bitos guardados";
                setTimeout(() => syncStatus.style.display = 'none', 2000);
                
            } catch (error) {
                console.error("Error guardando h√°bitos:", error);
                syncStatus.textContent = "‚ùå Error guardando";
            }
        }

        function generarHabitosUI() {
            habitosGrid.innerHTML = '';
            
            Object.keys(habitos).forEach(categoria => {
                const habitosCategoria = habitos[categoria];
                if (habitosCategoria.length > 0) {
                    const habitoCard = document.createElement('div');
                    habitoCard.className = 'habito-card';
                    
                    let icono = 'üåÖ';
                    let titulo = 'Ma√±ana';
                    if (categoria === 'dia') {
                        icono = '‚ö°';
                        titulo = 'D√≠a';
                    } else if (categoria === 'noche') {
                        icono = 'üåô'; 
                        titulo = 'Noche';
                    }
                    
                    habitoCard.innerHTML = `
                        <h3>${icono} ${titulo}</h3>
                        <ul class="checklist" id="checklist-${categoria}">
                            ${habitosCategoria.map((habito, index) => `
                                <li>
                                    <input type="checkbox" id="habito-${categoria}-${index}">
                                    <label for="habito-${categoria}-${index}">${habito}</label>
                                    <button class="btn-eliminar" onclick="eliminarHabito('${categoria}', ${index})">√ó</button>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    
                    habitosGrid.appendChild(habitoCard);
                }
            });
            
            cargarEstadosCheckboxes();
        }

        async function eliminarHabito(categoria, index) {
            if (confirm('¬øEst√°s seguro de eliminar este h√°bito?')) {
                habitos[categoria].splice(index, 1);
                await guardarHabitos();
                generarHabitosUI();
            }
        }

        async function agregarHabito() {
            const texto = document.getElementById('nuevoHabito').value.trim();
            const categoria = document.getElementById('categoriaHabito').value;
            
            if (texto) {
                habitos[categoria].push(texto);
                await guardarHabitos();
                
                document.getElementById('nuevoHabito').value = '';
                cerrarModalAgregar();
                generarHabitosUI();
            }
        }

        // =============================================
        // FUNCIONES DE HISTORIAL Y PROGRESO
        // =============================================
        async function guardarDia() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            let completados = 0;
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    completados++;
                }
            });
            
            const porcentaje = Math.round((completados / checkboxes.length) * 100);
            const fecha = new Date().toISOString().split('T')[0];
            
            try {
                syncStatus.style.display = 'block';
                syncStatus.textContent = "üíæ Guardando d√≠a...";
                
                const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                
                const registro = {
                    fecha: fecha,
                    habitos: checkboxes.length,
                    completados: completados,
                    porcentaje: porcentaje,
                    timestamp: serverTimestamp()
                };
                
                await setDoc(doc(window.firebaseDb, 'usuarios', usuarioId, 'historial', fecha), registro);
                
                syncStatus.textContent = "‚úÖ D√≠a guardado";
                setTimeout(() => syncStatus.style.display = 'none', 2000);
                
                alert('‚úÖ D√≠a guardado en Firebase correctamente');
                generarSemana();
                await actualizarEstadisticas();
                
            } catch (error) {
                console.error("Error guardando d√≠a:", error);
                syncStatus.textContent = "‚ùå Error guardando";
                alert('‚ùå Error al guardar en Firebase');
            }
        }

        async function cargarHistorial() {
            try {
                const { collection, query, orderBy, limit, getDocs } = window.firebaseModules;
                
                const historialRef = collection(window.firebaseDb, 'usuarios', usuarioId, 'historial');
                const q = query(historialRef, orderBy('fecha', 'desc'), limit(30));
                const snapshot = await getDocs(q);
                
                const historial = [];
                snapshot.forEach(doc => {
                    historial.push(doc.data());
                });
                
                return historial;
            } catch (error) {
                console.error("Error cargando historial:", error);
                return [];
            }
        }

        // =============================================
        // FUNCIONES DE UI Y ESTAD√çSTICAS
        // =============================================
        function generarSemana() {
            const dias = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
            semanaGrid.innerHTML = '';
            
            dias.forEach((dia, index) => {
                const diaCard = document.createElement('div');
                diaCard.className = 'dia-card';
                const progreso = Math.random() * 100;
                diaCard.innerHTML = `
                    <strong>${dia}</strong>
                    <div>${Math.round(progreso)}%</div>
                `;
                
                if (progreso > 70) {
                    diaCard.classList.add('completado');
                }
                
                semanaGrid.appendChild(diaCard);
            });
        }

        async function actualizarEstadisticas() {
            const historial = await cargarHistorial();
            const hoy = new Date().toISOString().split('T')[0];
            
            // Encontrar registro de hoy
            const registroHoy = historial.find(reg => reg.fecha === hoy);
            
            if (registroHoy) {
                document.getElementById('statRacha').textContent = registroHoy.racha || 0;
                document.getElementById('statHabitos').textContent = registroHoy.porcentaje + '%';
                document.getElementById('progresoHabitos').style.width = registroHoy.porcentaje + '%';
                document.getElementById('contadorHabitos').textContent = registroHoy.porcentaje + '% completado';
            }
            
            // Calcular d√≠as del mes
            const diasEsteMes = historial.filter(reg => {
                const fechaReg = new Date(reg.fecha);
                const mesReg = fechaReg.getMonth();
                const a√±oReg = fechaReg.getFullYear();
                const hoy = new Date();
                return mesReg === hoy.getMonth() && a√±oReg === hoy.getFullYear();
            }).length;
            
            document.getElementById('progresoDias').style.width = Math.min((diasEsteMes / 30) * 100, 100) + '%';
            document.getElementById('contadorDias').textContent = diasEsteMes + '/30 d√≠as';
            
            // Otras stats
            document.getElementById('statSemanas').textContent = Math.floor((registroHoy?.racha || 0) / 7);
            document.getElementById('statMejora').textContent = Math.min((registroHoy?.racha || 0) * 5, 100) + '%';
        }

        // =============================================
        // FUNCIONES AUXILIARES
        // =============================================
        function cargarEstadosCheckboxes() {
            const estados = JSON.parse(localStorage.getItem('estadosCheckboxes') || '{}');
            Object.keys(estados).forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = estados[id];
                }
            });
            
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const estados = {};
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        estados[cb.id] = cb.checked;
                    });
                    localStorage.setItem('estadosCheckboxes', JSON.stringify(estados));
                });
            });
        }

        function mostrarModalAgregar() {
            modalAgregar.style.display = 'flex';
        }

        function cerrarModalAgregar() {
            modalAgregar.style.display = 'none';
        }

        async function exportarDatos() {
            const historial = await cargarHistorial();
            const datos = {
                habitos: habitos,
                historial: historial,
                exportado: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `planificador-marcos-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // =============================================
        // INICIALIZACI√ìN
        // =============================================
        async function inicializarPanel() {
            const hoy = new Date();
            fechaHoy.textContent = hoy.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            await cargarHabitos();
            generarSemana();
            await actualizarEstadisticas();
        }

        // =============================================
        // LOGIN Y AUTENTICACI√ìN
        // =============================================
        function verificarPassword() {
            if (document.getElementById('passwordInput').value === APP_PASSWORD) {
                loginContainer.style.display = 'none';
                panelContainer.style.display = 'block';
                inicializarPanel();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function cerrarSesion() {
            panelContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }

        // =============================================
        // INICIALIZAR AL CARGAR LA P√ÅGINA
        // =============================================
        window.onload = async function() {
            document.getElementById('passwordInput').focus();
            await inicializarFirebase();
        };

        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verificarPassword();
            }
        });
    </script>
</body>
</html>
